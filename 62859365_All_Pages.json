[{"items": [{"tags": ["python", "python-3.x", "tensorflow", "tensorflow-datasets"], "owner": {"user_type": "does_not_exist", "display_name": "user11173832"}, "is_answered": false, "view_count": 597, "answer_count": 0, "score": 0, "last_activity_date": 1594546282, "creation_date": 1594546282, "question_id": 62859365, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/62859365/cannot-add-tensor-to-the-batch-number-of-elements-does-not-match-shapes-are", "title": "Cannot add tensor to the batch: number of elements does not match. Shapes are: [tensor]: [2], [batch]: [5]", "body": "<pre><code>tensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot add tensor to the batch: number of elements does not match. Shapes are: [tensor]: [2], [batch]: [5]\n</code></pre>\n<p>I got this error when I increase the batch size 1 to any number <br/></p>\n<pre><code>def train():\n    print('train')\n    print(tf.__version__)\n    batch_size= 8\n    images,boxes,labels,difficulties,new_boxes= PascalVOCDataset()\n    new_boxes = list(new_boxes)\n\n\n    boxes = tf.ragged.constant(boxes)\n    labels = tf.ragged.constant(labels)\n    new_boxes = tf.ragged.constant(new_boxes)\n\n    print('boxes-&gt;',boxes.shape)\n    print('labels-&gt;',labels.shape)\n    print('images-&gt;', np.array(images).shape)\n\n    dataset = tf.data.Dataset.from_tensor_slices((images,new_boxes,labels))\n    run_train(dataset.map(resize_image_bbox, num_parallel_calls=tf.data.experimental.AUTOTUNE).batch(batch_size).prefetch(tf.data.experimental.AUTOTUNE))\n</code></pre>\n<p>and the shape result is</p>\n<pre><code>boxes-&gt; (5717, None, None)\nlabels-&gt; (5717, None)\nimages-&gt; (5717,)\n\n\ndef run_train(dataset, num_epochs=1):\n    start_time = time.perf_counter()\n    print('run_train')\n    model = SSD(n_classes=20)\n    criterion = MultiBoxLoss(priors_cxcy=model.priors_cxcy)\n    print('dataset-&gt;',dataset)\n\n    for _ in tf.data.Dataset.range(num_epochs):\n        for idx,(images,boxes,labels) in enumerate(dataset): # (batch_size (N), 300, 300, 3)\n            print('=========================================================')\n            images = np.array(images)\n            labels = np.array(labels)\n            boxes = np.array(list(boxes))\n            print('image_shape-&gt;', images.shape)\n            print('labels_shape-&gt;',labels.shape)\n            print('boxes_shape-&gt;',boxes.shape)\n\n            if isprint: tf.print(type(images), type(labels),images.shape,labels.shape)\n            predicted_locs, predicted_socres = model(images)# (N, 8732, 4), (N, 8732, n_classes)\n            loss = criterion(predicted_locs,predicted_socres,boxes,labels)\n            print('loss-&gt;',loss)\n            if idx ==10: break\n        pass\n</code></pre>\n<p>the whole error message as following <br/></p>\n<pre><code>Traceback (most recent call last):\n  File &quot;/home/jake/Gits/ssd_tensorflow/train.py&quot;, line 62, in &lt;module&gt;\n    main()\n  File &quot;/home/jake/Gits/ssd_tensorflow/train.py&quot;, line 60, in main\n    train()\n  File &quot;/home/jake/Gits/ssd_tensorflow/train.py&quot;, line 57, in train\n    run_train(dataset.map(resize_image_bbox, num_parallel_calls=tf.data.experimental.AUTOTUNE).batch(batch_size).prefetch(tf.data.experimental.AUTOTUNE))\n  File &quot;/home/jake/Gits/ssd_tensorflow/train.py&quot;, line 24, in run_train\n    for idx,(images,boxes,labels) in enumerate(dataset): # (batch_size (N), 300, 300, 3)\n  File &quot;/home/jake/venv/lib/python3.7/site-packages/tensorflow/python/data/ops/iterator_ops.py&quot;, line 631, in __next__\n    return self.next()\n  File &quot;/home/jake/venv/lib/python3.7/site-packages/tensorflow/python/data/ops/iterator_ops.py&quot;, line 670, in next\n    return self._next_internal()\n  File &quot;/home/jake/venv/lib/python3.7/site-packages/tensorflow/python/data/ops/iterator_ops.py&quot;, line 661, in _next_internal\n    return structure.from_compatible_tensor_list(self._element_spec, ret)\n  File &quot;/usr/lib/python3.7/contextlib.py&quot;, line 130, in __exit__\n    self.gen.throw(type, value, traceback)\n  File &quot;/home/jake/venv/lib/python3.7/site-packages/tensorflow/python/eager/context.py&quot;, line 1989, in execution_mode\n    executor_new.wait()\n  File &quot;/home/jake/venv/lib/python3.7/site-packages/tensorflow/python/eager/executor.py&quot;, line 67, in wait\n    pywrap_tfe.TFE_ExecutorWaitForAllPendingNodes(self._handle)\ntensorflow.python.framework.errors_impl.InvalidArgumentError: Cannot add tensor to the batch: number of elements does not match. Shapes are: [tensor]: [2], [batch]: [5]\n\nProcess finished with exit code 1\n</code></pre>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 74}]