[{"items": [{"tags": ["python", "tensorflow"], "owner": {"user_type": "does_not_exist", "display_name": "user2489252"}, "is_answered": true, "view_count": 1596, "accepted_answer_id": 45662279, "answer_count": 1, "score": 1, "last_activity_date": 1502640131, "creation_date": 1502639824, "question_id": 45662230, "content_license": "CC BY-SA 3.0", "link": "https://stackoverflow.com/questions/45662230/how-to-exit-a-tensorflow-session-with-a-queue-runner", "title": "How to exit a TensorFlow session with a queue runner", "body": "<p>Say I have defined a function that loads one label/features pair from a TfRecords file as follows</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>def read_one_image(tfrecords_path):\n\n    queue = tf.train.string_input_producer([tfrecords_path])\n    reader = tf.TFRecordReader()\n    key, value = reader.read(queue)\n    features = tf.parse_single_example(value,\n        features={'label': tf.FixedLenFeature([], tf.int64),\n                  'image': tf.FixedLenFeature([784], tf.int64)})\n    label = features['label']\n    image = features['image']\n    return label, image\n</code></pre>\n\n<p>Fetching the images in a session works fine if I keep the session open:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>tf.reset_default_graph()\n\nlabel, image = read_one_image(\"mnist_train.tfrecords\")\n\nsess = tf.Session()\n\ninit = tf.global_variables_initializer()\nsess.run(init)\ntf.train.start_queue_runners(sess=sess)\n\nfor i in range(10):\n    one_label, one_image = sess.run([label, image])\n\nprint(one_label, one_image.shape)\n</code></pre>\n\n<p>However, if I use a context manager like so</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>g = tf.Graph()\nwith g.as_default():\n\n    label, image = read_one_image(\"mnist_train.tfrecords\")\n\n\nwith tf.Session(graph=g) as sess:\n    sess.run(tf.global_variables_initializer())\n\n    tf.train.start_queue_runners(sess=sess)\n    for i in range(10):\n        one_label, one_image = sess.run([label, image])\n\n    print(one_label, one_image.shape)\n</code></pre>\n\n<p>I get an error: <code>7 ERROR:tensorflow:Exception in QueueRunner: Attempted to use a closed Session.(784,)</code></p>\n\n<p>Maybe I am misunderstanding how the queue runner works, but since I called the <code>sess.run</code> method, it should have fetched a data pair 10 times. Now, is there a way to quit/exit/close the session without exhausting the queue?</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 97}]