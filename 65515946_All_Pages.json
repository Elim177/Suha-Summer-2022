[{"items": [{"tags": ["javascript", "deep-learning", "gradient-descent", "tensorflow.js", "deep-dream"], "owner": {"account_id": 20335524, "reputation": 1, "user_id": 14916362, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/d32a213ce1c714a1821852a7232d4958?s=256&d=identicon&r=PG&f=1", "display_name": "N.Sahnee", "link": "https://stackoverflow.com/users/14916362/n-sahnee"}, "is_answered": false, "view_count": 134, "answer_count": 0, "score": 0, "last_activity_date": 1609381901, "creation_date": 1609381901, "question_id": 65515946, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/65515946/tensorflow-js-throws-puzzling-error-when-calling-tf-grad-for-gradient-ascent", "title": "tensorflow.js throws puzzling error when calling tf.grad() for gradient ascent", "body": "<p>For a course I'm taking, I am to implement <strong>deep dream</strong> for feature visualization. I chose to realize this project in the browser. As for my background, I am new to Machine Learning and <strong>Tensorflow.js.</strong></p>\n<p>Mostly, I have followed this guide for the Python API of Tensorflow:<br />\n<a href=\"https://www.tensorflow.org/tutorials/generative/deepdream#calculate_loss\" rel=\"nofollow noreferrer\">https://www.tensorflow.org/tutorials/generative/deepdream#calculate_loss</a></p>\n<p>So far, I was able to implement all the steps until Gradient Ascent. I had a feeling that calculating the <strong>gradients</strong> would be a challenge, since the Python API has this convenient tf.GradientTape() construct, which Tensorflow.js does not have. From my understanding I have to use <strong>tf.grad() or tf.grads()</strong> instead.<br />\nThis is my loss function:</p>\n<pre class=\"lang-js prettyprint-override\"><code>function calc_loss(model, img_tensor) {\n    const activations = [].concat(model.predict(img_tensor));\n\n    const losses = activations.map( v =&gt; tf.mean(v))\n\n    const means = losses.reduce((acc, val) =&gt; {\n        acc = tf.add(acc, val);\n        return acc;\n    })\n    return tf.sum(means)        // unsure if tf.sum() is needed here\n}\n</code></pre>\n<p>I pass it the feature extraction model and a tensor4d and it returns a tensor with 1 value.</p>\n<p>The (partial) gradient ascent function I used:</p>\n<pre class=\"lang-js prettyprint-override\"><code>function gradient_ascent(model, img_tensor) {\n    \n    const img_batch = img_tensor.expandDims(0);\n\n    const loss_function = (input) =&gt; calc_loss(model, input);\n\n    const grad_function = tf.grad(loss_function);\n    return grad_function(img_batch)\n}\n</code></pre>\n<p>The error it throws:</p>\n<pre><code>Uncaught (in promise) TypeError: x is undefined\n    clone http://127.0.0.1:8080/tf.2.8.2.js:17122\n    saved http://127.0.0.1:8080/tf.2.8.2.js:17373\n    saveTensorsForBackwardMode http://127.0.0.1:8080/tf.2.8.2.js:17372\n    kernelFunc http://127.0.0.1:8080/tf.2.8.2.js:17277\n    runKernelFunc http://127.0.0.1:8080/tf.2.8.2.js:17324\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    runKernelFunc http://127.0.0.1:8080/tf.2.8.2.js:17318\n    runKernel http://127.0.0.1:8080/tf.2.8.2.js:17171\n    batchNorm_ http://127.0.0.1:8080/tf.2.8.2.js:26574\n    f2 http://127.0.0.1:8080/tf.2.8.2.js:18338\n    batchNorm4d_ http://127.0.0.1:8080/tf.2.8.2.js:26746\n    f2 http://127.0.0.1:8080/tf.2.8.2.js:18338\n    batchNormalization http://127.0.0.1:8080/tf.2.8.2.js:72769\n    normalizeInference http://127.0.0.1:8080/tf.2.8.2.js:72966\n    call http://127.0.0.1:8080/tf.2.8.2.js:72971\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17080\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17075\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:24132\n    call http://127.0.0.1:8080/tf.2.8.2.js:72942\n    apply http://127.0.0.1:8080/tf.2.8.2.js:56063\n    nameScope http://127.0.0.1:8080/tf.2.8.2.js:53015\n    apply http://127.0.0.1:8080/tf.2.8.2.js:56019\n    execute http://127.0.0.1:8080/tf.2.8.2.js:59585\n    batchOuts http://127.0.0.1:8080/tf.2.8.2.js:63644\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17080\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17075\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:24132\n    _loop2 http://127.0.0.1:8080/tf.2.8.2.js:63620\n    predictLoop http://127.0.0.1:8080/tf.2.8.2.js:63652\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17080\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17075\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:24132\n    predictLoop http://127.0.0.1:8080/tf.2.8.2.js:63601\n    predict http://127.0.0.1:8080/tf.2.8.2.js:63704\n    calc_loss http://127.0.0.1:8080/utils.js:103\n    loss_function http://127.0.0.1:8080/utils.js:124\n    gradients http://127.0.0.1:8080/tf.2.8.2.js:29870\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17080\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17075\n    y http://127.0.0.1:8080/tf.2.8.2.js:17798\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    gradients http://127.0.0.1:8080/tf.2.8.2.js:17793\n    grad http://127.0.0.1:8080/tf.2.8.2.js:29869\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17080\n    scopedRun http://127.0.0.1:8080/tf.2.8.2.js:17094\n    tidy http://127.0.0.1:8080/tf.2.8.2.js:17075\n    grad http://127.0.0.1:8080/tf.2.8.2.js:29868\n    gradient_ascent http://127.0.0.1:8080/utils.js:127\n    handleTest http://127.0.0.1:8080/script.js:74\n    promise callback*handleTest/&lt; http://127.0.0.1:8080/script.js:69\n    promise callback*handleTest http://127.0.0.1:8080/script.js:68\n    EventListener.handleEvent* http://127.0.0.1:8080/script.js:126\n</code></pre>\n<p>What I've tried:</p>\n<ul>\n<li>I have replaced the loss function and the function to calculate the gradients with <em>inputGradientAscent()</em> from <a href=\"https://github.com/tensorflow/tfjs-examples/blob/master/visualize-convnet/filters.js\" rel=\"nofollow noreferrer\">this repo (tfjs-examples)</a>, but got a similar error. Instead of x is undefined, it show _this2.gamma is undefined.</li>\n<li>I didn't gain any insight by using the debugger.</li>\n<li>I've used tf.js version 2.0, 2.4, 2.7 and now 2.8.2, with the same result.</li>\n</ul>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 270}]