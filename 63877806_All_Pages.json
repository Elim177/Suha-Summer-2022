[{"items": [{"tags": ["python", "tensorflow", "keras", "deep-learning", "tensorflow1.15"], "owner": {"account_id": 1733015, "reputation": 8685, "user_id": 1586200, "user_type": "registered", "accept_rate": 62, "profile_image": "https://www.gravatar.com/avatar/111c497a3eb270092100e5ee807d9994?s=256&d=identicon&r=PG&f=1", "display_name": "Autonomous", "link": "https://stackoverflow.com/users/1586200/autonomous"}, "is_answered": false, "view_count": 728, "answer_count": 0, "score": 1, "last_activity_date": 1600102196, "creation_date": 1600054980, "last_edit_date": 1600102196, "question_id": 63877806, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/63877806/tensorflow-keras-custom-metrics-error-on-update-state", "title": "Tensorflow Keras custom metrics error on update_state()", "body": "<h2>Context</h2>\n<p>Using TF 1.15 with <code>tf.Estimator</code> interface to train and evaluate models. Trying to write a custom TF metric, using <a href=\"https://www.tensorflow.org/api_docs/python/tf/keras/metrics/Metric\" rel=\"nofollow noreferrer\"><code>tf.keras.metric.Metric</code></a> for that.</p>\n<h2>Problem</h2>\n<p>I wrote a custom metric and included that in the <code>eval_metrics_ops</code> (example below). If I define an estimator with the metrics, I get the following error.</p>\n<pre><code>ValueError: Please call update_state(...) on the &quot;&lt;metric_name&gt;&quot; metric \n</code></pre>\n<p>The wording of the error looks clear (I have to call <code>update_state()</code>) but I am not sure where do I call <code>update_state()</code> on the metric (not sure if I even should call). Not a minimal example, but this is a demo metric I wrote.</p>\n<pre><code>class MyMetric(tf.keras.metrics.Metric):\n    def __init__(self, name=&quot;my_metric&quot;, **kwargs):\n        super(MyMetric, self).__init__(name=name, **kwargs)\n\n    def update_state(self, y_true, y_pred, sample_weight=None):\n        self.true_samples = tf.reduce_sum(y_true)\n    \n    def result(self):\n        return self.true_samples\n</code></pre>\n<p>Creating a <code>dict</code> where metric name is the key and the metric instance is the value. <a href=\"https://www.tensorflow.org/api_docs/python/tf/estimator/EstimatorSpec\" rel=\"nofollow noreferrer\">This</a> is where it mentions how to create a <code>dict</code> for <code>eval_metrics_ops</code>.</p>\n<pre><code>metrics_ops = {&quot;my_metric&quot;: MyMetric()}`. # The TensorFlow 1.15 documentation does not say we have to call `update_state(....) anywhere.`\nestimator_spec = tf.estimator.EstimatorSpec(mode, model.loss, eval_metric_ops=metrics_ops)\n</code></pre>\n<p>Any idea how I can get rid of that error?</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 184}]