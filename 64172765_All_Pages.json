[{"items": [{"tags": ["python", "tensorflow", "backpropagation"], "owner": {"account_id": 17140862, "reputation": 27, "user_id": 12404907, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/ff81c7077583b54a340c90441095ac47?s=256&d=identicon&r=PG&f=1", "display_name": "MolochHorridus", "link": "https://stackoverflow.com/users/12404907/molochhorridus"}, "is_answered": false, "view_count": 206, "answer_count": 0, "score": 0, "last_activity_date": 1601650414, "creation_date": 1601646842, "last_edit_date": 1601650414, "question_id": 64172765, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/64172765/tensorflow-custom-gradients-dont-backpropagate", "title": "Tensorflow custom gradients don&#39;t backpropagate", "body": "<p>I'm trying to understand custom gradients in tensorflow with <code>tf.custom_gradient</code>, so I was trying to reproduce a simple matrix multiplication with its gradients, where I'm only interested with the gradient with respect to the weight matrix.</p>\n<pre><code>@tf.custom_gradient\ndef matrixmul(x, weight):\n    res = tf.matmul(x, weight)\n\n    def grad(dy):\n        grad_x = None\n        grad_w = tf.matmul(x, dy, transpose_a=True)\n        return grad_x, grad_w\n\n    return res, grad\n</code></pre>\n<p>This gives the right gradient whenever I don't my custom gradient is not used in the backpropagation, but when I do multiple multiplications the gradient doesn't propagate back and I get <code>None</code> as a result for <code>grad_w1</code>.</p>\n<p>For example:</p>\n<pre><code>with tf.GradientTape() as tape:\n    temp = matrixmul(x, w1)\n    pred = tf.matmul(temp, w2)\n    loss = tf.reduce_sum(tf.norm(pred - y, axis=-1))\ngrad_w1 = tape.gradient(loss, w1)\n\n</code></pre>\n<pre><code>with tf.GradientTape() as tape:\n    temp = tf.matmul(x, w1)\n    pred = matrixmul(temp, w2)\n    loss = tf.reduce_sum(tf.norm(pred - y, axis=-1))\ngrad_w1 = tape.gradient(loss, w1)\n\n</code></pre>\n<p>The first snippet gives the right gradients, but the second snippet results in <code>None</code>.</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 285}]