[{"items": [{"tags": ["python", "deep-learning", "tensorflow2.0", "tf.keras"], "owner": {"account_id": 159497, "reputation": 3806, "user_id": 378917, "user_type": "registered", "accept_rate": 71, "profile_image": "https://www.gravatar.com/avatar/abead84f26e350a05bf0c63392a54cb4?s=256&d=identicon&r=PG", "display_name": "ThR37", "link": "https://stackoverflow.com/users/378917/thr37"}, "is_answered": true, "view_count": 811, "answer_count": 1, "score": 5, "last_activity_date": 1619009201, "creation_date": 1575285762, "last_edit_date": 1575460175, "question_id": 59137907, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/59137907/knowledge-distillation-loss-with-tensorflow-2-keras", "title": "Knowledge Distillation loss with Tensorflow 2 + Keras", "body": "<p>I am trying to implement a very simple keras model that uses Knowledge Distillation [1] from another model.\nRoughly, I need to replace the original loss <code>L(y_true, y_pred)</code> by <code>L(y_true, y_pred)+L(y_teacher_pred, y_pred)</code> where <code>y_teacher_pred</code> is the prediction of another model.</p>\n\n<p>I've tried to do</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>def create_student_model_with_distillation(teacher_model):\n\n  inp = tf.keras.layers.Input(shape=(21,))\n\n  model = tf.keras.models.Sequential()\n  model.add(inp)\n\n  model.add(...) \n  model.add(tf.keras.layers.Dense(units=1))\n\n  teacher_pred = teacher_model(inp)\n\n  def my_loss(y_true,y_pred):\n      loss = tf.keras.losses.mean_squared_error(y_true, y_pred)\n      loss += tf.keras.losses.mean_squared_error(teacher_pred, y_pred)\n      return loss\n\n  model.compile(loss=my_loss, optimizer='adam')\n\n  return model\n</code></pre>\n\n<p>However, when I try to call <code>fit</code> on my model, I am getting</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>TypeError: An op outside of the function building code is being passed\na \"Graph\" tensor. It is possible to have Graph tensors\nleak out of the function building context by including a\ntf.init_scope in your function building code.\n</code></pre>\n\n<p>How can I solve this issue ?</p>\n\n<p>Refs</p>\n\n<p>[1] <a href=\"https://arxiv.org/abs/1503.02531\" rel=\"noreferrer\">https://arxiv.org/abs/1503.02531</a></p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 174}]