[{"items": [{"tags": ["python", "tensorflow", "keras"], "owner": {"account_id": 963556, "reputation": 1375, "user_id": 987397, "user_type": "registered", "accept_rate": 32, "profile_image": "https://www.gravatar.com/avatar/fa7ae7d9bd13c2d04335c3209865c262?s=256&d=identicon&r=PG", "display_name": "Derk", "link": "https://stackoverflow.com/users/987397/derk"}, "is_answered": false, "view_count": 1625, "answer_count": 1, "score": 2, "last_activity_date": 1556901010, "creation_date": 1556890204, "question_id": 55970851, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/55970851/tensorflow-model-fit-does-not-work-with-strings-as-labels", "title": "Tensorflow model.fit() does not work with strings as labels", "body": "<p>See this code example:</p>\n\n<pre><code>import tensorflow as tf\nimport numpy as np\n\nimages = np.random.rand(5, 108, 56, 3)\ny_pred = np.random.rand(5, 4)\ny_true = np.array(['aa', 'bb', 'cc', 'dd', 'ee'])\n\ndataset = tf.data.Dataset.from_tensor_slices((images, y_true))\ndataset = dataset.batch(5)\ndataset = dataset.repeat()\n\nmodel = tf.keras.Sequential([\n    tf.keras.layers.Conv2D(16, [3,3], activation='relu'),\n    tf.keras.layers.GlobalAveragePooling2D(),\n    tf.keras.layers.Dense(4)\n])\n\ndef triplet_loss(y_true, y_pred):\n    all_diffs = tf.expand_dims(y_pred, axis=1) - tf.expand_dims(y_pred, axis=0)\n    distances = tf.sqrt(tf.reduce_sum(tf.square(all_diffs), axis=-1) + 1e-12)\n\n    furthest_positive = tf.reduce_max(distances, axis=1)\n\n    closest_negative = tf.map_fn(lambda x: tf.reduce_min(x),\n                             distances)\n\n    diff = furthest_positive - closest_negative\n    diff = tf.nn.softplus(diff)\n\n    return diff\n\noptimizer = tf.optimizers.Adam(learning_rate=0.001)\n\nmodel.compile(loss=triplet_loss,\n          optimizer=optimizer)\n\nmodel.fit(dataset, steps_per_epoch=5, epochs=10, verbose=1)\n</code></pre>\n\n<p>Here y_true contains strings which can be compared (suppose some metric learning experiment). The network outputs a feature vector for each input. Inputs with same labels should be similar in the feature space.</p>\n\n<p>However this code gives as error:</p>\n\n<blockquote>\n  <p>tensorflow.python.framework.errors_impl.UnimplementedError: Cast\n  string to float is not supported [Op:Cast] name: Cast/</p>\n</blockquote>\n\n<p>It seems like it can not deal with the strings as labels and tries to cast them to a float somewhere.</p>\n\n<p>But when I use a gradientTape instead of model.fit there is no problem</p>\n\n<pre><code>for images, labels in dataset:\n    with tf.GradientTape() as tape:\n        y_pred = model(images, training=True)\n        loss_value = triplet_loss(labels, y_pred)\n\n        grads = tape.gradient(loss_value, model.trainable_variables)\n        optimizer.apply_gradients(zip(grads, model.trainable_variables))\n        print('iteration done')\n</code></pre>\n\n<p>This works fine. Is this a bug in model.fit()? Is there some workaround possible to be able to still use model.fit()?</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 269}]