[{"items": [{"tags": ["python", "numpy", "tensorflow", "matplotlib"], "owner": {"account_id": 15116032, "reputation": 30058, "user_id": 10908375, "user_type": "registered", "profile_image": "https://i.stack.imgur.com/L7f8w.jpg?s=256&g=1", "display_name": "Nicolas Gervais", "link": "https://stackoverflow.com/users/10908375/nicolas-gervais"}, "is_answered": true, "view_count": 393, "answer_count": 1, "score": 2, "last_activity_date": 1599753753, "creation_date": 1598346108, "last_edit_date": 1599753753, "question_id": 63575474, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/63575474/how-do-i-transform-relative-bounding-boxes-after-cropping", "title": "How do I transform relative bounding boxes after cropping?", "body": "<p>I need to use bounding boxes in this format, according to <a href=\"https://www.tensorflow.org/api_docs/python/tf/image/draw_bounding_boxes\" rel=\"nofollow noreferrer\"><code>tf.image.draw_bounding_boxes</code></a>:</p>\n<pre><code>[y_min, x_min, y_max, x_max]\n</code></pre>\n<p>I have this image of shape <code>(720, 1280, 3)</code> (full size image <a href=\"https://imgur.com/a/MJ575e3\" rel=\"nofollow noreferrer\">here</a>):</p>\n<p><a href=\"https://i.stack.imgur.com/OPGtv.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/OPGtv.png\" alt=\"enter image description here\" /></a></p>\n<p>And I have bounding boxes:</p>\n<pre><code>array([[0.134722 , 0.425    , 0.327778 , 0.5      ],\n       [0.294444 , 0.3140625, 0.444444 , 0.4124995],\n       [0.473611 , 0.294531 , 0.636111 , 0.417969 ],\n       [0.5972225, 0.392968 , 0.7986115, 0.497656 ],\n       [0.5416665, 0.486719 , 0.6999995, 0.645313 ],\n       [0.3986115, 0.425    , 0.5319445, 0.546094 ],\n       [0.3499995, 0.5726565, 0.5041665, 0.6710935],\n       [0.215278 , 0.507031 , 0.383334 , 0.590625 ]])\n</code></pre>\n<p>It works with the rectangle image:</p>\n<pre><code>image = plt.imread(myimage) \nx = tf.image.draw_bounding_boxes(image[None, ...], \n                             np.array(bboxes)[None, ...], \n                             [[255., 0., 0.] for i in range(len(bboxes))])\nplt.imshow(x[0, ...].numpy().astype(np.uint8))\nplt.show()\n</code></pre>\n<p><a href=\"https://i.stack.imgur.com/xduiR.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/xduiR.png\" alt=\"enter image description here\" /></a></p>\n<p>But it's all failing when I crop my picture to a square:</p>\n<pre><code>image = plt.imread(myimage)[:, 280:-280]\nx = tf.image.draw_bounding_boxes(image[None, ...], \n                             np.array(bboxes)[None, ...], \n                             [[255., 0., 0.] for i in range(len(bboxes))])\nplt.imshow(x[0, ...].numpy().astype(np.uint8))\nplt.show()\n</code></pre>\n<p><a href=\"https://i.stack.imgur.com/joAsw.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/joAsw.png\" alt=\"enter image description here\" /></a></p>\n<p>How can I have the right bounding boxes after cropping to a square? I'm looking to have a 640x640 square, then I will resize to 320x320.</p>\n<p>**Edit: ** This worked:</p>\n<pre><code> h, w, c = image.shape\n    h_pad = 640 - h\n    w_pad = 640 - w\n    image = np.pad(image, [[h_pad//2, h_pad//2], \n                           [w_pad//2, w_pad//2], [0, 0]], mode='edge')\n    train_images_np.append(image) \n    \n    annotations = []\n    labels_temp = []\n    with open(annot_path) as txtfile:\n        reader = csv.reader(txtfile, delimiter=',')\n        for row in reader:\n            annotations.append(list([(h*(2*float(row[0])-1)/640+1)/2, \n                                     (w*(2*float(row[1])-1)/640+1)/2, \n                                     (h*(2*float(row[2])-1)/640+1)/2, \n                                     (w*(2*float(row[3])-1)/640+1)/2\n                                    ]))\n</code></pre>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 191}]