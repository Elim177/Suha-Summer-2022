[{"items": [{"tags": ["python", "tensorflow", "keras", "computer-vision", "conv-neural-network"], "owner": {"account_id": 26373, "reputation": 43816, "user_id": 68571, "user_type": "registered", "accept_rate": 79, "profile_image": "https://i.stack.imgur.com/Yw9Lg.png?s=256&g=1", "display_name": "VansFannel", "link": "https://stackoverflow.com/users/68571/vansfannel"}, "is_answered": false, "view_count": 387, "answer_count": 0, "score": 0, "last_activity_date": 1624723372, "creation_date": 1597176082, "question_id": 63365561, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/63365561/trying-to-use-dice-coef-loss-function-with-images-of-int16", "title": "Trying to use dice coef loss function with images of int16", "body": "<p>I'm using Python 3.7.7. and Tensorflow 2.3.0.</p>\n<p>When I try to use this loss function:</p>\n<pre><code>def dice_coef(y_true, y_pred):\n    y_true_f = K.flatten(y_true)\n    y_pred_f = K.flatten(y_pred)\n    intersection = K.sum(y_true_f * y_pred_f)\n    return (2 * intersection + 1) // (K.sum(y_true_f) + K.sum(y_pred_f) + 1)\n\ndef dice_coef_loss(y_true, y_pred):\n    return 1-dice_coef(y_true, y_pred)\n</code></pre>\n<p>With U-Net:</p>\n<pre><code>model.compile(tf.keras.optimizers.Adam(lr=(1e-4) * 2), loss=dice_coef_loss, metrics=['accuracy'])\n</code></pre>\n<p>I get this error:</p>\n<pre><code>TypeError                                 Traceback (most recent call last)\n\n&lt;ipython-input-25-91bea884e0c8&gt; in &lt;module&gt;()\n----&gt; 1 results = model.fit(X_train, y_train, batch_size=4, epochs=50, validation_data=(X_valid, y_valid))\n\n            10 frames\n\n/usr/local/lib/python3.6/dist-packages/tensorflow/python/framework/func_graph.py in wrapper(*args, **kwargs)\n    971           except Exception as e:  # pylint:disable=broad-except\n    972             if hasattr(e, &quot;ag_error_metadata&quot;):\n--&gt; 973               raise e.ag_error_metadata.to_exception(e)\n    974             else:\n    975               raise\n\nTypeError: in user code:\n\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/keras/engine/training.py:806 train_function  *\n        return step_function(self, iterator)\n    &lt;ipython-input-19-deec0ad5082f&gt;:8 dice_coef_loss  *\n        return 1-dice_coef(y_true, y_pred)\n    &lt;ipython-input-24-8de47985e665&gt;:4 dice_coef  *\n        intersection = K.sum(y_true_f * y_pred_f)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/ops/math_ops.py:1141 binary_op_wrapper\n        raise e\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/ops/math_ops.py:1125 binary_op_wrapper\n        return func(x, y, name=name)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/ops/math_ops.py:1457 _mul_dispatch\n        return multiply(x, y, name=name)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/util/dispatch.py:201 wrapper\n        return target(*args, **kwargs)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/ops/math_ops.py:509 multiply\n        return gen_math_ops.mul(x, y, name)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/ops/gen_math_ops.py:6176 mul\n        &quot;Mul&quot;, x=x, y=y, name=name)\n    /usr/local/lib/python3.6/dist-packages/tensorflow/python/framework/op_def_library.py:506 _apply_op_helper\n        inferred_from[input_arg.type_attr]))\n\n    TypeError: Input 'y' of 'Mul' Op has type float32 that does not match type int16 of argument 'x'.\n</code></pre>\n<p>Any idea about how to fix it?</p>\n<p>I have also tried with this version:</p>\n<pre><code>def dice_coef(y_true, y_pred):\n    y_true_f = K.flatten(y_true)\n    y_pred_f = K.flatten(y_pred)\n    intersection = K.sum(y_true_f * y_pred_f)\n    return (2.0 * intersection + 1.0) / (K.sum(y_true_f) + K.sum(y_pred_f) + 1.0)\n\ndef dice_coef_loss(y_true, y_pred):\n    return 1-dice_coef(y_true, y_pred)\n</code></pre>\n<p>But I get the same error.</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 198}]