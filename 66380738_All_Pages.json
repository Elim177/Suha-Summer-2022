[{"items": [{"tags": ["python", "tensorflow", "hessian", "hessian-matrix"], "owner": {"account_id": 14629546, "reputation": 55, "user_id": 10565817, "user_type": "registered", "profile_image": "https://lh4.googleusercontent.com/-3eNEIYaed0s/AAAAAAAAAAI/AAAAAAAAADI/Yqhfq7ogGS0/photo.jpg?sz=256", "display_name": "MyPrunus", "link": "https://stackoverflow.com/users/10565817/myprunus"}, "is_answered": false, "view_count": 77, "answer_count": 0, "score": 1, "last_activity_date": 1614341963, "creation_date": 1614318534, "last_edit_date": 1614341963, "question_id": 66380738, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/66380738/hessian-matrix-w-r-t-parameter-of-mlp-is-not-symmetric-tf2-0", "title": "Hessian matrix w.r.t parameter of MLP is not symmetric (TF2.0)", "body": "<p>I tried to calculate the Hessian matrix w.r.t. model parameters</p>\n<p>However, each tensor shape in the Hessian matrix was not symmetric.</p>\n<pre><code>import tensorflow as tf\n\nx_train = tf.constant(tf.random.uniform(shape=(100, 24), minval=0, maxval=100))\ny_train = tf.constant(tf.random.uniform(shape=(100, 1), minval=0, maxval=1))\n\nx_test = tf.constant(tf.random.uniform(shape=(17, 24), minval=0, maxval=100))\ny_test = tf.constant(tf.random.uniform(shape=(17, 1), minval=0, maxval=1))\n\nf = tf.keras.models.Sequential()\nf.add(tf.keras.layers.Dense(30, activation='relu', use_bias=False))\nf.add(tf.keras.layers.Dense(1, activation='sigmoid', use_bias=False))\nf.compile(loss='binary_crossentropy')\nf.fit(x_train, y_train)\n\nws = f.trainable_weights\n\nwith tf.GradientTape(persistent=True) as tape2:\n    tape2.watch(x_train)\n    with tf.GradientTape(persistent=True) as tape1:\n        tape1.watch(x_train)\n        y_hat = f(x_train)\n        loss = tf.keras.losses.binary_crossentropy(y_train, y_hat)\n    grads = tape1.gradient(loss, ws)\n    \nH = [tape2.gradient(grad, ws) for grad in grads]\n\nprint([h_elem.shape for _H in H for h_elem in _H])\n</code></pre>\n<p>The output is</p>\n<pre><code>[TensorShape([24, 30]), TensorShape([30, 1]), TensorShape([24, 30]), TensorShape([30, 1])]\n</code></pre>\n<p>I expected the shape of</p>\n<pre><code>[[24,30], [30, 1], [30, 1], [30,1]]\n</code></pre>\n<p>considering the symmetric characteristics of the Hessian matrix. However, I don't know why the 3rd tensor shape was <code>[24, 30]</code> in my code.</p>\n<p>I suspected this is because the hessian matrix is follow equation:</p>\n<pre><code>[df(x)/dL1L1, df(x)/dL1,L2, df(x)/dL2,L1, df(x)/dL2,L2]\n</code></pre>\n<p>where <code>L</code> is parameters of layer.</p>\n<p>In this case, the 2nd, 3rd element is not the same shape.</p>\n<p>Is it correct?</p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 198}]