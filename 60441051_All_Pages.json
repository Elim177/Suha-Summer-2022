[{"items": [{"tags": ["tensorflow"], "owner": {"account_id": 108161, "reputation": 5951, "user_id": 287238, "user_type": "registered", "accept_rate": 75, "profile_image": "https://i.stack.imgur.com/oQJH2.jpg?s=256&g=1", "display_name": "mathtick", "link": "https://stackoverflow.com/users/287238/mathtick"}, "is_answered": false, "view_count": 194, "answer_count": 0, "score": 1, "last_activity_date": 1585041746, "creation_date": 1582834318, "last_edit_date": 1585041746, "question_id": 60441051, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/60441051/is-there-a-way-of-getting-a-tensorflow-cumsum-with-a-stop-gradient-at-each-sum", "title": "Is there a way of getting a tensorflow cumsum with a stop_gradient at each sum?", "body": "<p>So basically something like </p>\n\n<pre><code>w[t+1] = stop_gradient(w[t]) + dw[t]\n</code></pre>\n\n<p>but efficient. I'm assuming that a for loop is not great compared to cumsum.</p>\n\n<p>I can also just restructure the code but there might be a clever way to make this work and it would be easier to read. </p>\n\n<p>UPDATE:</p>\n\n<p>Here is a simple example restructuring the problem to avoid the cumsum:</p>\n\n<pre><code>import pandas as pd\nfrom pylab import *\nion()\nimport numpy as np\nimport tensorflow as tf\ndef get_loss(w, lr=1.0):\n    n = tf.range(w[0].shape[0] - 1, dtype=tf.float32)\n    loss = 0\n    dw = w[1:] - tf.stop_gradient(w[:-1])\n    temp = lr * tf.reduce_sum(dw ** 2, axis=range(1, len(w.shape)))\n    loss += tf.reduce_sum(temp) / 2\n    return loss\n\nopt = tf.keras.optimizers.SGD(learning_rate=0.1)\nw = tf.keras.backend.variable(np.sin(np.linspace(0, 10 * np.pi, 1000)[:, None]))\n\nw_ = [w.numpy()]\n\nfor i in range(1000):\n    with tf.GradientTape() as tape:\n        loss = get_loss(w) \n    g = tape.gradient(loss, [w])\n    opt.apply_gradients(zip(g, [w]))\n    if i % 200 == 0:\n        w_.append(w.numpy())\n\nww = np.hstack(w_)\n\nfigure(1)\nclf()\nplot(ww, alpha=0.5)\nshow()\n</code></pre>\n\n<p><a href=\"https://i.stack.imgur.com/Ssfkk.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/Ssfkk.png\" alt=\"enter image description here\"></a></p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 88}]