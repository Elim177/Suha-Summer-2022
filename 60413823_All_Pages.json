[{"items": [{"tags": ["python", "tensorflow", "keras", "deep-learning", "tensorflow2.0"], "owner": {"account_id": 10129457, "reputation": 875, "user_id": 7483509, "user_type": "registered", "accept_rate": 20, "profile_image": "https://lh3.googleusercontent.com/-rLN-a5QG95Q/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3reidV1ZIp-ccT7ykiC9GJpJ54O-4A/mo/photo.jpg?sz=256", "display_name": "Nick Skywalker", "link": "https://stackoverflow.com/users/7483509/nick-skywalker"}, "is_answered": false, "view_count": 611, "answer_count": 0, "score": 2, "last_activity_date": 1582723896, "creation_date": 1582719612, "last_edit_date": 1582723896, "question_id": 60413823, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/60413823/mirroredstrategy-inputs-to-eager-execution-function-cannot-be-keras-symbolic-te", "title": "MirroredStrategy: Inputs to eager execution function cannot be Keras symbolic tensors", "body": "<p>I'm using tensorflow 2.0 to train a model, my data pipeline and model train fine with <code>tf.keras.Model.fit()</code> on a single gpu, but when I try running it on multi gpu with <code>MirroredStrategy</code>.</p>\n\n<p>My dataset is obtained with something like this:</p>\n\n<pre><code>dataset = tf.data.TFRecordDataset(records)\ndataset.map(parse_and_decode)\nmap_augmentation = lambda *args: tf.py_function(\n    augmentation,\n    [*args],\n    4*[tf.float32]\n)\ndataset.map(map_augmentation)\n\ndef map_ground_truth(arg1, arg2, arg3, arg4):\n    ret_values = tf.py_function(\n        get_ground_truth,\n        [arg1, arg2, arg3, arg4],\n        [tf.float32, tf.float32, tf.float32, tf.float32, tf.float32, tf.float32\n    )\n    # set_shape based on https://github.com/tensorflow/tensorflow/issues/24520\n    for ret_val in ret_values:\n        ret_val.set_shape([None for _ in range(3)])\n    return *ret_values\n\ndataset.map(map_ground_truth)\n\nmodel.fit(dataset)\n</code></pre>\n\n<p>This works ok without using <code>MirroredStrategy</code> but when I introduce it I get this error:</p>\n\n<pre><code>_SymbolicException: Inputs to eager execution function cannot be Keras symbolic tensors, but found [&lt;tf.Tensor 'crowd_mask:0' shape=(1, 401, 401, 1) dtype=float32&gt;, &lt;tf.Tensor 'unannotated_mask:0' shape=(1, 401, 401, 1) dtype=float32&gt;, &lt;tf.Tensor 'kp_maps_true:0' shape=(1, 401, 401, 17) dtype=float32&gt;, &lt;tf.Tensor 'mid_offsets/Identity:0' shape=(1, 13, 13, 64) dtype=float32&gt;]\n</code></pre>\n\n<p>(in the <code>strategy.scope()</code> are the model and losses creations, the model <code>compile</code> and the <code>fit</code>. No manual call to <code>strategy.experimental_distribute_dataset</code> is done on the dataset as this is aparently handled by the <code>fit</code> function). </p>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 4}]