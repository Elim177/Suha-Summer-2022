[{"items": [{"tags": ["python", "tensorflow", "keras"], "owner": {"account_id": 19355049, "reputation": 11, "user_id": 14151563, "user_type": "registered", "profile_image": "https://www.gravatar.com/avatar/fc6b9ee5fccc2098b9b78082f2f425a9?s=256&d=identicon&r=PG&f=1", "display_name": "bucketking1", "link": "https://stackoverflow.com/users/14151563/bucketking1"}, "is_answered": false, "view_count": 187, "answer_count": 0, "score": 0, "last_activity_date": 1601496344, "creation_date": 1601496237, "last_edit_date": 1601496344, "question_id": 64144927, "content_license": "CC BY-SA 4.0", "link": "https://stackoverflow.com/questions/64144927/not-sure-if-tensorflow-is-running-on-gpu-or-cpu-custom-keras-training-loop-or-if", "title": "not sure if tensorflow is running on GPU or CPU custom keras training loop or if its a problem with the training loop code", "body": "<p>the python script is using 20% of my CPU and only 0.3% of my GPU.\nI am still very new to Keras and TensorFlow so it is not at all unlikely that I am doing something wrong which is causing this excessive slowness. program should be running for 15000 training episodes with each episode consisting of 400 steps. No images or fancy stuff is used, the state is just a simple list of 3 elements. At the current rate it would take about 100 hours to run all 15000 episodes. I would really like to be sure that TensorFlow is using my GPU to run if someone can help me with that.\nadditionally if anyone has any comments on my custom training loop i would greatly appreciate that too.</p>\n<p>---Custom Training loop---</p>\n<pre><code>for episode in range(1,num_training_episodes+1):\n    done = False\n    episode_reward = 0\n    state = env.reset_environment(sat)\n    for step in range(num_steps):\n\n        action = agent.select_action(state, policy_net)\n        new_state, episode_reward, done = env.step(sat, action)\n        memory.push(Experience(state.copy(), action, new_state.copy(), episode_reward))\n        state = new_state\n\n        if memory.can_provide_sample(batch_size):\n\n            states, actions, new_states, rewards = memory.sample(batch_size)\n\n            next_q_values = target_net.predict(new_states)\n            target_q_values = rewards +gamma*tf.reduce_max(next_q_values, axis = 1)\n\n            masks = tf.one_hot(actions, num_actions)\n\n            with tf.GradientTape() as tape:\n                q_values = policy_net(np.array([states]))[0]\n\n                q_action = tf.reduce_sum(tf.multiply(q_values, masks), axis = 1)\n\n                loss = loss_func(target_q_values, q_action)\n\n            grads = tape.gradient(loss, policy_net.trainable_variables)\n            optimizer.apply_gradients(zip(grads, policy_net.trainable_variables))\n\n        if (done == True) or (step == num_steps-1):\n            reward_list.append(episode_reward)\n            break\n\n    if (episode % target_update) == 0:\n        for layer_policy,layer_target in zip(policy_net.layers,target_net.layers):\n            layer_target.set_weights(layer_policy.get_weights())\n\n    if (episode % print_every) == 0:\n        print(&quot;Episode:&quot;, episode-print_every, &quot;to:&quot;, episode, &quot;Number of correct stops:&quot;, env.correct_stop_counter, &quot;Mean rewards:&quot;, np.mean(reward_list[episode-print_every:episode]))\n</code></pre>\n<p>---console output---</p>\n<pre><code>2020-09-30 21:47:06.446861: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cudart64_101.dll\n2020-09-30 21:47:08.497370: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library nvcuda.dll\n2020-09-30 21:47:08.527588: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1716] Found device 0 with properties: \npciBusID: 0000:01:00.0 name: GeForce GTX 1060 computeCapability: 6.1\ncoreClock: 1.6705GHz coreCount: 10 deviceMemorySize: 6.00GiB deviceMemoryBandwidth: 178.99GiB/s\n2020-09-30 21:47:08.528543: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cudart64_101.dll\n2020-09-30 21:47:08.534707: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cublas64_10.dll\n2020-09-30 21:47:08.540359: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cufft64_10.dll\n2020-09-30 21:47:08.542732: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library curand64_10.dll\n2020-09-30 21:47:08.548640: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cusolver64_10.dll\n2020-09-30 21:47:08.552110: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cusparse64_10.dll\n2020-09-30 21:47:08.565173: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cudnn64_7.dll\n2020-09-30 21:47:08.565677: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1858] Adding visible gpu devices: 0\nNum GPUs Available:  1\n2020-09-30 21:47:08.576341: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN)to use the following CPU instructions in performance-critical operations:  AVX2\nTo enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.\n2020-09-30 21:47:08.588414: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x18df008a400 initialized for platform Host (this does not guarantee that XLA will be used). Devices:\n2020-09-30 21:47:08.589123: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version\n2020-09-30 21:47:08.590160: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1716] Found device 0 with properties: \npciBusID: 0000:01:00.0 name: GeForce GTX 1060 computeCapability: 6.1\ncoreClock: 1.6705GHz coreCount: 10 deviceMemorySize: 6.00GiB deviceMemoryBandwidth: 178.99GiB/s\n2020-09-30 21:47:08.590965: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cudart64_101.dll\n2020-09-30 21:47:08.591530: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cublas64_10.dll\n2020-09-30 21:47:08.591898: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cufft64_10.dll\n2020-09-30 21:47:08.592195: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library curand64_10.dll\n2020-09-30 21:47:08.592657: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cusolver64_10.dll\n2020-09-30 21:47:08.593051: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cusparse64_10.dll\n2020-09-30 21:47:08.593582: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cudnn64_7.dll\n2020-09-30 21:47:08.594160: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1858] Adding visible gpu devices: 0\n2020-09-30 21:47:09.346067: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1257] Device interconnect StreamExecutor with strength 1 edge matrix:\n2020-09-30 21:47:09.346584: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1263]      0 \n2020-09-30 21:47:09.346967: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1276] 0:   N \n2020-09-30 21:47:09.347409: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1402] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 4826 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1060, pci bus id: 0000:01:00.0, compute capability: 6.1)\n2020-09-30 21:47:09.352153: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x18da6c97700 initialized for platform CUDA (this does not guarantee that XLA will be used). Devices:\n2020-09-30 21:47:09.352903: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): GeForce GTX 1060, Compute Capability 6.1\nModel: &quot;sequential&quot;\n_________________________________________________________________\nLayer (type)                 Output Shape              Param #   \n=================================================================\ndense (Dense)                (None, 24)                96        \n_________________________________________________________________\ndense_1 (Dense)              (None, 48)                1200      \n_________________________________________________________________\ndense_2 (Dense)              (None, 24)                1176      \n_________________________________________________________________\ndense_3 (Dense)              (None, 5)                 125       \n=================================================================\nTotal params: 2,597\nTrainable params: 2,597\nNon-trainable params: 0\n_________________________________________________________________\nModel: &quot;sequential_1&quot;\n_________________________________________________________________\nLayer (type)                 Output Shape              Param #   \n=================================================================\ndense_4 (Dense)              (None, 24)                96        \n_________________________________________________________________\ndense_5 (Dense)              (None, 48)                1200      \n_________________________________________________________________\ndense_6 (Dense)              (None, 24)                1176      \n_________________________________________________________________\ndense_7 (Dense)              (None, 5)                 125       \n=================================================================\nTotal params: 2,597\nTrainable params: 2,597\nNon-trainable params: 0\n_________________________________________________________________\n2020-09-30 21:47:09.444165: I tensorflow/stream_executor/platform/default/dso_loader.cc:48] Successfully opened dynamic library cublas64_10.dll\n</code></pre>\n"}], "has_more": false, "quota_max": 300, "quota_remaining": 178}]